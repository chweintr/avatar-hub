# Railway Deployment - LiveKit + Simli Setup

## Architecture
- **Web Service**: Node/Express serving React app + minting LiveKit tokens
- **Worker Service**: Python LiveKit Agents worker running Simli avatar

## Environment Variables Required

### Web Service (avatar-hub)
Add these in Railway dashboard → avatar-hub service → Variables:

```
NODE_ENV=production
PORT=${{PORT}}

# LiveKit credentials (for minting user tokens)
LIVEKIT_URL=wss://your-livekit-cloud.livekit.cloud
LIVEKIT_API_KEY=APIxxxxxxxxx
LIVEKIT_API_SECRET=xxxxxxxxxxxxxx
```

### Worker Service (worker-tax or python-worker)
Add these in Railway dashboard → worker service → Variables:

```
# LiveKit credentials (same as web service)
LIVEKIT_URL=wss://your-livekit-cloud.livekit.cloud
LIVEKIT_API_KEY=APIxxxxxxxxx
LIVEKIT_API_SECRET=xxxxxxxxxxxxxx

# Simli credentials
SIMLI_API_KEY=your_actual_simli_api_key
SIMLI_FACE_ID=afdb6a3e-3939-40aa-92df-01604c23101c

# OpenAI (for agent LLM/TTS)
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxx
```

## Deployment Steps

1. **Push code to GitHub** (already done ✓)

2. **Deploy Web Service**:
   - Railway will auto-detect and deploy from `railway.json`
   - Verify health check at: `https://your-app.railway.app/health`
   - Test token endpoint: `https://your-app.railway.app/api/livekit-token?room=avatar-tax&user=test`
   - Should return: `{"url":"wss://...","token":"eyJ..."}`

3. **Deploy Worker Service**:
   - Create new service in Railway
   - Set root directory: `services/worker-tax`
   - Railway will auto-detect Python and use `requirements.txt`
   - Start command should be: `python main.py start`
   - Check logs for: "Worker started" and no import errors

4. **Verify Integration**:
   - Visit your app URL
   - Click "Connect" on the Tax Advisor avatar
   - Browser console should show: `[livekit] connected to room: avatar-tax`
   - Within 3-5 seconds, avatar video should appear in the circle
   - Speak into mic → avatar should respond with lip-sync

## Troubleshooting

### Web service returns "Token 500"
- Check LIVEKIT_URL, LIVEKIT_API_KEY, LIVEKIT_API_SECRET are set in web service
- Verify values match your LiveKit Cloud dashboard

### Worker fails to start
- Check Railway logs for import errors
- Verify SIMLI_API_KEY and SIMLI_FACE_ID are set
- Ensure LIVEKIT_* vars are in worker service (not just web)

### Avatar doesn't appear after Connect
- Check LiveKit dashboard → Rooms → avatar-tax
- Should see 2 participants: your browser + the avatar agent
- If only 1 participant: worker isn't starting the avatar (check worker logs)
- If 0 participants: token endpoint isn't working (check web logs)

### Avatar appears but doesn't respond to voice
- Check browser mic permission is granted
- Check worker logs for "Audio received" or similar
- Verify OPENAI_API_KEY is set in worker service

## Railway Service URLs
- Web: Auto-generated by Railway (e.g., `avatar-hub-production.railway.app`)
- Worker: Doesn't need public URL (connects to LiveKit directly)

## Important Notes
- Both web and worker need the **same** LIVEKIT_URL/API_KEY/API_SECRET
- Use Railway's "Promote to shared" if you want to share vars between services
- Worker service only needs to be running when someone connects (can scale to 0 when idle)
