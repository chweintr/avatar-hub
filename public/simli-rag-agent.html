<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>RAG-Powered Avatar</title>
    <style>
      :root { --simli-scale: 0.82; --circle-d: min(58vmin, 640px); --circle-cy: 40vh; }
      html,body{height:100%;margin:0;background:#000}
      #video{position:fixed;left:50%;top:50%;
             transform:translate(-50%,-50%) scale(var(--simli-scale));
             width:100vw;height:100vh;object-fit:cover;background:#000}
      #audio{display:none}
      #status{position:fixed;inset:0;display:grid;place-items:center;color:#fff;font:14px system-ui}
      #startBtn{
        position:fixed;
        left:calc(50% - 70px);
        top:calc(var(--circle-cy) + (var(--circle-d) / 2) - 60px);
        width:140px;height:44px;border-radius:9999px;border:0;
        background:#000;color:#fff;font:14px/44px system-ui;cursor:pointer;
        box-shadow:0 10px 30px rgba(0,0,0,.18);
      }
    </style>
  </head>
  <body>
    <div id="status">Connecting to RAG-powered avatarâ€¦</div>
    <video id="video" autoplay playsinline></video>
    <audio id="audio" autoplay></audio>
    <button id="startBtn">Connect</button>

    <script type="module">
      import { SimliClient } from "https://cdn.jsdelivr.net/npm/simli-client@latest/+esm";

      const status   = document.getElementById("status");
      const startBtn = document.getElementById("startBtn");
      const video    = document.getElementById("video");
      const audio    = document.getElementById("audio");

      const qp       = new URLSearchParams(location.search);
      const faceID   = qp.get("faceId") || "";
      const avatarId = qp.get("id");
      const useRag   = qp.get("useRag") === "true";
      const scaleQP  = parseFloat(qp.get("scale") || "");
      if (!Number.isNaN(scaleQP)) {
        document.documentElement.style.setProperty("--simli-scale", String(scaleQP));
      }

      let ragWebSocket = null;

      if (!faceID) {
        status.textContent = "Missing faceId";
        throw new Error("no faceId");
      }

      try {
        const r = await fetch("/api/simli-config");
        if (!r.ok) {
          status.textContent = "Failed to get API key";
          throw new Error("API key fetch failed");
        }
        const { apiKey } = await r.json();

        const client = new SimliClient();
        client.Initialize({
          apiKey,
          faceID,
          handleSilence: true,
          maxSessionLength: 3600,
          maxIdleTime: 600,
          videoRef: video,
          audioRef: audio,
          enableConsoleLogs: true,
        });

        startBtn.addEventListener("click", async () => {
          try {
            await client.start();
            startBtn.style.display = "none";
          } catch (e) {
            console.error(e);
            status.textContent = "Permission blocked. Click again.";
          }
        });

        client.on("connected", () => {
          console.log("Connected to Simli");
          status.style.display = "none";

          if (useRag && avatarId === "grants") {
            connectToRAG();
          }
        });

        client.on("failed", () => {
          status.textContent = "Simli connection failed";
          if (ragWebSocket) ragWebSocket.close();
        });

        client.on("error", (err) => {
          console.error("Simli error:", err);
          status.textContent = "Simli error";
        });

        client.on("speech", (data) => {
          console.log("User said:", data.text);
          if (useRag && ragWebSocket && ragWebSocket.readyState === WebSocket.OPEN) {
            ragWebSocket.send(JSON.stringify({ type: "query", text: data.text }));
          }
        });

        async function connectToRAG() {
          try {
            const res = await fetch("/api/rag/ws");
            const { wsUrl } = await res.json();

            ragWebSocket = new WebSocket(wsUrl);

            ragWebSocket.onopen = () => {
              console.log("Connected to RAG backend");
            };

            ragWebSocket.onmessage = (event) => {
              const data = JSON.parse(event.data);
              if (data.type === "response" && client) {
                client.sendText(data.text);
              }
            };

            ragWebSocket.onerror = (err) => {
              console.error("RAG error:", err);
            };
          } catch (err) {
            console.error("Failed to connect to RAG:", err);
          }
        }

        window.addEventListener("message", (e) => {
          if (e.origin !== location.origin) return;
          if (e.data?.type === "SIMLI_SET_SCALE") {
            const v = Number(e.data?.payload);
            if (!Number.isNaN(v)) document.documentElement.style.setProperty("--simli-scale", String(v));
          }
        });

      } catch (error) {
        console.error("Init error:", error);
        status.textContent = "Error: " + error.message;
      }
    </script>
  </body>
</html>
