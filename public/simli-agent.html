<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Simli Agent</title>
    <style>
      :root { --simli-scale: 0.82; --circle-d: min(58vmin, 640px); --circle-cy: 40vh; }
      html,body{height:100%;margin:0;background:transparent;overflow:hidden}
      /* Fullscreen, centered, zoomable video */
      #video{
        position:fixed;left:50%;top:50%;
        transform:translate(-50%,-50%) scale(var(--simli-scale));
        width:100vw;height:100vh;object-fit:cover;background:#000;
        /* REMOVE debug outline to stop the visible square corners */
        outline: none;
      }
      #audio{display:none}
      #status{
        position:fixed;inset:0;display:grid;place-items:center;
        color:#fff;font:14px/1.4 system-ui;text-align:center;pointer-events:none;z-index:1000
      }
      /* In-iframe Connect button – must be visible */
      #startBtn{
        position:fixed;left:calc(50% - 70px);
        top:calc(var(--circle-cy) + (var(--circle-d)/2) - 60px);
        width:140px;height:44px;border:0;border-radius:9999px;background:#fff;color:#000;
        font:14px/44px system-ui;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,.18);z-index:1001
      }
    </style>
  </head>
  <body>
    <div id="status">Booting…</div>
    <video id="video" autoplay playsinline></video>
    <audio id="audio" autoplay></audio>
    <button id="startBtn">Connect</button>

    <script type="module">
      const status  = document.getElementById("status");
      const startBtn= document.getElementById("startBtn");
      const video   = document.getElementById("video");
      const audio   = document.getElementById("audio");
      const say = (m) => { console.log("[simli]", m); status.textContent = m; };

      const qp = new URLSearchParams(location.search);
      const faceID  = (qp.get("faceId") || "").trim();
      const agentId = (qp.get("agentId") || "").trim();
      const scaleQP = parseFloat(qp.get("scale") || "");
      if (!Number.isNaN(scaleQP)) document.documentElement.style.setProperty("--simli-scale", String(scaleQP));
      if (!faceID) { status.textContent = "Missing faceId"; throw new Error("no faceId"); }

      say("Fetching API key…");
      const r = await fetch("/api/simli-config", { cache: "no-store" });
      if (!r.ok) throw new Error("Failed to get API key");
      const { apiKey } = await r.json();

      say("Loading SDK…");
      const mod = await import("https://cdn.jsdelivr.net/npm/simli-client@1.2.15/+esm");
      const SimliClient = mod?.SimliClient || mod?.default;
      if (!SimliClient) throw new Error("SDK export not found");

      say("Creating client…");
      const client = new SimliClient();

      const initCfg = {
        apiKey,
        faceID, faceId: faceID,      // support either name
        videoRef: video,
        audioRef: audio,
        handleSilence: true,
        enableConsoleLogs: true,
      };
      if (agentId) initCfg.agentId = agentId;

      const init = client.Initialize?.bind(client) || client.initialize?.bind(client);
      if (!init) throw new Error("No Initialize/initialize on client");

      say("Initializing…");
      await init(initCfg);
      say("Ready. Click Connect.");

      async function startNow() {
        try {
          say("Starting…");
          const start = client.start?.bind(client) || client.connect?.bind(client);
          if (!start) throw new Error("No start/connect on client");
          await start();
          startBtn.style.display = "none";
          say("Connected.");
        } catch (e) {
          console.error(e);
          say("Start failed: " + (e?.message || e));
        }
      }

      // User gesture INSIDE iframe (required by browser)
      startBtn.addEventListener("click", startNow);

      // Optional: allow parent to request start/scale
      window.addEventListener("message", (e) => {
        if (e.origin !== location.origin) return;
        if (e.data?.type === "SIMLI_START") startNow();
        if (e.data?.type === "SIMLI_SET_SCALE") {
          const v = Number(e.data?.payload);
          if (!Number.isNaN(v)) document.documentElement.style.setProperty("--simli-scale", String(v));
        }
      });
    </script>
  </body>
</html>
