<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Simli Agent</title>
    <style>
      html,body{height:100%;margin:0;background:#000}
      #root{position:absolute;inset:0;display:grid;place-items:center;color:#fff;font:14px/1.4 system-ui}
      #video-container{position:absolute;inset:0;display:none}
      video,audio{width:0;height:0}
    </style>
  </head>
  <body>
    <div id="root">Connectingâ€¦</div>
    <div id="video-container">
      <video id="video" autoplay playsinline></video>
      <audio id="audio" autoplay></audio>
    </div>

    <script type="module">
      import { SimliClient } from "https://cdn.jsdelivr.net/npm/simli-client@latest/+esm";

      const root   = document.getElementById("root");
      const video  = document.getElementById("video");
      const audio  = document.getElementById("audio");

      const qp      = new URLSearchParams(location.search);
      const faceID  = qp.get("faceId");
      const agentId = qp.get("agentId");

      if (!faceID) {
        root.textContent = "Missing faceId";
        throw new Error("no faceId");
      }

      try {
        // Get the API key from server
        const r = await fetch("/api/simli-config");
        if (!r.ok) {
          root.textContent = "Failed to get API key";
          throw new Error("API key fetch failed");
        }
        const { apiKey } = await r.json();

        // Initialize per Simli docs
        const client = new SimliClient();
        client.Initialize({
          apiKey,
          faceID,
          handleSilence: true,
          maxSessionLength: 3600,
          maxIdleTime: 600,
          videoRef: video,
          audioRef: audio,
          enableConsoleLogs: true,
        });

        client.on("connected", () => {
          console.log("Connected to Simli");
          root.style.display = "none";
        });

        client.on("failed", () => {
          root.textContent = "Simli connection failed";
        });

        client.on("error", (err) => {
          console.error("Simli error:", err);
          root.textContent = "Simli error";
        });

        await client.start();
      } catch (error) {
        console.error("Init error:", error);
        root.textContent = "Error: " + error.message;
      }
    </script>
  </body>
</html>
