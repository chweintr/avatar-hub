<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Simli Agent</title>
    <style>
      :root { --simli-scale: 0.85; }
      html,body{height:100%;margin:0;background:#000}
      #status{position:fixed;inset:0;display:grid;place-items:center;color:#fff;font:14px system-ui}
      #video{position:fixed;left:50%;top:50%;
             transform:translate(-50%,-50%) scale(var(--simli-scale));
             width:100vw;height:100vh;object-fit:cover;background:#000}
      #audio{display:none}
    </style>
  </head>
  <body>
    <div id="status">Connectingâ€¦</div>
    <video id="video" autoplay playsinline></video>
    <audio id="audio" autoplay></audio>

    <script type="module">
      import { SimliClient } from "https://cdn.jsdelivr.net/npm/simli-client@latest/+esm";

      const status = document.getElementById("status");
      const video  = document.getElementById("video");
      const audio  = document.getElementById("audio");
      const qp     = new URLSearchParams(location.search);
      const faceID = qp.get("faceId") || "";
      const agentId = qp.get("agentId") || "";

      if (!faceID) { status.textContent = "Missing faceId"; throw new Error("no faceId"); }

      // Get API key from server
      const r = await fetch("/api/simli-config");
      if (!r.ok) { status.textContent = "Failed to get API key"; throw new Error("boot 500"); }
      const { apiKey } = await r.json();

      const client = new SimliClient();
      client.Initialize({
        apiKey, faceID,
        videoRef: video, audioRef: audio,
        handleSilence: true, enableConsoleLogs: true,
      });

      client.on("connected", () => {
        status.style.display = "none";
        parent?.postMessage({ type: "SIMLI_READY" }, location.origin);
      });
      client.on("error", (e) => { console.error(e); status.textContent = "Simli error"; });

      // message API from parent
      window.addEventListener("message", (e) => {
        if (e.origin !== location.origin) return;
        const { type, payload } = e.data || {};
        if (type === "SIMLI_START") client.start();
        if (type === "SIMLI_SET_SCALE") {
          document.documentElement.style.setProperty("--simli-scale", String(payload || 0.85));
        }
      });
    </script>
  </body>
</html>
