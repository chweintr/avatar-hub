<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Simli Agent</title>
    <style>
      :root { --simli-scale: 0.80; --circle-d: min(58vmin, 640px); --circle-cy: 40vh; }
      html,body{height:100%;margin:0;background:#000}
      #video{
        position:fixed;left:50%;top:50%;
        transform:translate(-50%,-50%) scale(var(--simli-scale));
        width:100vw;height:100vh;object-fit:cover;background:#000;
        outline: 2px solid rgba(255,0,0,.15);
      }
      #audio{display:none}
      #status{
        position:fixed;inset:0;display:grid;place-items:center;
        color:#fff;font:14px/1.4 system-ui;text-align:center;pointer-events:none
      }
      #startBtn{
        position:fixed;left:calc(50% - 70px);
        top:calc(var(--circle-cy) + (var(--circle-d) / 2) - 60px);
        width:140px;height:44px;border-radius:9999px;border:0;background:#000;color:#fff;
        font:14px/44px system-ui;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,.18)
      }
      #selfTest{
        position:fixed;left:16px;bottom:16px;
        padding:8px 12px;border-radius:9999px;border:0;background:#222;color:#fff;font:12px;opacity:.8
      }
    </style>
  </head>
  <body>
    <div id="status">Booting…</div>
    <video id="video" autoplay playsinline></video>
    <audio id="audio" autoplay></audio>
    <button id="startBtn">Connect</button>
    <button id="selfTest" title="Bypass SDK; show webcam directly">Self-test camera</button>

    <script type="module">
      const status  = document.getElementById("status");
      const startBtn= document.getElementById("startBtn");
      const selfBtn = document.getElementById("selfTest");
      const video   = document.getElementById("video");
      const audio   = document.getElementById("audio");
      const log = (msg) => { console.log("[simli]", msg); status.textContent = msg; };

      const qp = new URLSearchParams(location.search);
      const faceID  = (qp.get("faceId") || "").trim();
      const agentId = (qp.get("agentId") || "").trim();
      const scaleQP = parseFloat(qp.get("scale") || "");
      if (!Number.isNaN(scaleQP)) document.documentElement.style.setProperty("--simli-scale", String(scaleQP));

      startBtn.addEventListener("click", () => console.log("[simli] connect clicked"));

      selfBtn.addEventListener("click", async () => {
        try {
          log("Self-test: requesting camera…");
          const s = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          video.srcObject = s;
          status.textContent = "Self-test running (camera).";
        } catch (e) {
          status.textContent = "Self-test failed: " + (e?.message || e);
        }
      });

      try {
        if (!faceID) throw new Error("Missing faceId");

        log("Fetching API key…");
        const r = await fetch("/api/simli-config", { cache: "no-store" });
        if (!r.ok) throw new Error("Failed to get API key");
        const { apiKey } = await r.json();
        if (!apiKey) throw new Error("Empty API key");

        log("Loading SDK…");
        async function loadSDK() {
          const urls = [
            "https://cdn.jsdelivr.net/npm/simli-client@latest/+esm",
            "https://esm.sh/simli-client@latest",
            "https://unpkg.com/simli-client@latest/dist/index.js?module"
          ];
          let lastErr;
          for (const u of urls) {
            try { return await import(u); } catch (e) { console.warn("import fail", u, e); lastErr = e; }
          }
          throw lastErr || new Error("No SDK");
        }
        const mod = await loadSDK();
        const SimliClient = mod?.SimliClient || mod?.default || (window).SimliClient;
        if (!SimliClient) throw new Error("SDK export not found");

        log("Creating client…");
        const client = new SimliClient();

        const initCfg = {
          apiKey,
          faceID, faceId: faceID,
          videoRef: video,
          audioRef: audio,
          handleSilence: true,
          enableConsoleLogs: true,
        };
        if (agentId) initCfg.agentId = agentId;

        const initFn = (typeof client.Initialize === "function")
          ? client.Initialize.bind(client)
          : (typeof client.initialize === "function")
            ? client.initialize.bind(client)
            : null;
        if (!initFn) throw new Error("No Initialize/initialize on client");

        log("Initializing…");
        await initFn(initCfg);
        status.textContent = "Ready. Click Connect.";

        startBtn.onclick = async () => {
          try {
            log("Starting…");
            const startFn = (typeof client.start === "function")
              ? client.start.bind(client)
              : (typeof client.connect === "function")
                ? client.connect.bind(client)
                : null;
            if (!startFn) throw new Error("No start/connect method on client");
            await startFn();
            startBtn.style.display = "none";
            log("Connected.");
          } catch (e) {
            console.error(e);
            status.textContent = "Start failed: " + (e?.message || e);
          }
        };

        client.on?.("connected", () => { log("Connected (event)."); });
        client.on?.("failed",    () => { status.textContent = "Simli failed"; });
        client.on?.("error",  e  => { console.error(e); status.textContent = "Simli error"; });

        window.addEventListener("message", (e) => {
          if (e.origin !== location.origin) return;
          if (e.data?.type === "SIMLI_SET_SCALE") {
            const v = Number(e.data?.payload);
            if (!Number.isNaN(v)) document.documentElement.style.setProperty("--simli-scale", String(v));
          }
        });

      } catch (e) {
        console.error(e);
        status.textContent = "Init error: " + (e?.message || e);
      }
    </script>
  </body>
</html>
