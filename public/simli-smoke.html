<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Simli Smoke</title>
    <script src="https://cdn.jsdelivr.net/npm/simli-client@1.2.15/dist/simli-client.umd.js"></script>
    <style>
      body { background:#000; color:#fff; display:grid; place-items:center; height:100svh; margin:0; }
      .circle { width:min(58vmin,640px); height:min(58vmin,640px); border-radius:9999px; overflow:hidden; position:relative; }
      video, audio { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
      button { position:absolute; left:50%; transform:translateX(-50%); bottom:20px; }
      .ring { position:absolute; inset:0; border:2px solid #fff; border-radius:9999px; pointer-events:none; opacity:.85 }
      #status { position:absolute; top:10px; left:50%; transform:translateX(-50%); font:12px/1 system-ui; color:#ccc }
    </style>
  </head>
  <body>
    <div class="circle">
      <video id="v" autoplay playsinline></video>
      <audio id="a" autoplay playsinline></audio>
      <div class="ring"></div>
      <div id="status">Loading…</div>
      <button id="btn">Connect</button>
    </div>
    <script>
      const statusEl = document.getElementById('status');
      const btn = document.getElementById('btn');
      let client;
      (async () => {
        try {
          statusEl.textContent = "Fetching key…";
          const r = await fetch("/api/simli-config");
          if (!r.ok) throw new Error("HTTP " + r.status);
          const { apiKey, faceId } = await r.json();
          const Ctor = window.SimliClient?.SimliClient || window.SimliClient?.default || window.SimliClient;
          if (!Ctor) throw new Error("Simli UMD not found");
          client = new Ctor();
          const init = client.Initialize || client.initialize;
          await init({
            apiKey, faceId, faceID: faceId,
            videoRef: document.getElementById('v'), audioRef: document.getElementById('a'),
            enableConsoleLogs: true,
          });
          statusEl.textContent = "Ready";
        } catch (e) {
          statusEl.textContent = "Init error: " + (e?.message || e);
          console.error(e);
        }
      })();
      btn.onclick = async () => {
        try {
          const mic = await navigator.mediaDevices.getUserMedia({ audio: true });
          await (client.listenToMediastreamTrack?.(mic.getAudioTracks()[0]) ?? Promise.reject("no mic method"));
          await (client.start?.() ?? client.connect?.());
        } catch (e) { statusEl.textContent = "Start failed: " + (e?.message || e) }
      };
    </script>
  </body>
</html>
